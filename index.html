<!DOCTYPE html>
<html lang="bn"> <!-- Added lang attribute -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>সোশ্যাল মিডিয়া পোস্ট ম্যানেজমেন্ট</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Noto+Sans+Bengali:wght@400;500;700&display=swap" rel="stylesheet"> <!-- Added Noto Sans Bengali -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"> <!-- FontAwesome Icons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script> <!-- html2canvas for screenshots -->
    <style>
        /* Theme Colors */
        :root {
            --primary-color: #0d47a1; /* Dark Blue */
            --secondary-color: #1565c0; /* Medium Blue */
            --accent-color: #2e7d32; /* Dark Green */
            --background-gradient-start: #e3f2fd; /* Light Blue */
            --background-gradient-end: #bbdefb; /* Lighter Blue */
            --text-color: #212121; /* Dark Grey */
            --light-text-color: #424242; /* Medium Grey */
            --border-color: #e0e0e0; /* Light Grey */
            --hover-bg: #eef; /* Very Light Blue */
            --focus-glow: rgba(33, 150, 243, 0.5); /* Blue Glow */

            --status-completed: #388e3c; /* Dark Green */
            --status-partial: #fbc02d; /* Dark Yellow/Orange */
            --status-not-started: #d32f2f; /* Dark Red */
            --time-low: #d32f2f; /* Dark Red */
            --time-medium: #fbc02d; /* Dark Yellow/Orange */
        }


        /* General Styles */
        body {
            font-family: 'Noto Sans Bengali', 'Roboto', sans-serif; /* Prioritize Bengali font */
            margin: 0;
            padding: 25px;
            background: linear-gradient(135deg, var(--background-gradient-start) 0%, var(--background-gradient-end) 100%); /* Subtle gradient background */
            color: var(--text-color);
            line-height: 1.6;
            overflow-x: hidden; /* Prevent main body horizontal scroll */
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
            position: relative; /* Needed for absolute positioning of Home button */
            background-color: #fff; /* Add background to container for screenshot */
            padding-top: 50px; /* Adjust padding for sticky header */
            border-radius: 10px;
             box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
             min-height: 90vh; /* Ensure container takes up most of the viewport height */
        }

        h1, h2 {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 30px;
            animation: fadeInDown 1s ease-out;
            letter-spacing: 0.5px;
        }
        h2 {
            margin-top: 40px;
            margin-bottom: 25px;
            color: var(--secondary-color);
        }

        /* Home Button Style */
        .home-button {
            position: absolute;
            top: 20px;
            left: 15px; /* Adjust based on container padding */
            font-size: 1.8em; /* Larger icon */
            color: var(--primary-color);
            cursor: pointer;
            transition: transform 0.2s ease, color 0.2s ease;
            z-index: 20; /* Ensure it's above other content */
        }
        .home-button:hover {
            transform: scale(1.1);
            color: var(--accent-color);
        }
         /* Hide on print and screenshot */
         @media print, screen and (max-width: 9999px) { /* Hide on screen capture by default */
             .home-button, .action-buttons, .exclude-screenshot {
                 display: none !important;
             }
         }
          /* Make sure they are visible normally */
          body:not(.screenshot-mode) .home-button,
          body:not(.screenshot-mode) .action-buttons {
               display: flex; /* Use flex for action buttons */
               justify-content: center;
               flex-wrap: wrap; /* Allow buttons to wrap */
          }
           .action-buttons {
               gap: 15px; /* Space between buttons */
           }


        /* Table Styles (Facebook Section) */
        .table-container {
             overflow-x: auto; /* Enable scrolling for wide tables */
             margin-bottom: 40px;
             box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05); /* Lighter shadow */
             border-radius: 8px;
             background-color: #fff;
             animation: fadeInUp 1.2s ease-out;
             position: relative; /* Needed for sticky elements */
             border: 1px solid var(--border-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px; /* Minimum width for the table */
             /* Ensure white background behind sticky cells */
            background-color: #fff;
        }

        th, td {
            padding: 14px 18px; /* Adjusted padding */
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.3s ease, transform 0.05s ease; /* Faster transform */
            white-space: nowrap; /* Prevent text wrapping in cells */
            overflow: hidden;
            text-overflow: ellipsis;
            vertical-align: middle; /* Vertically center content */
        }

         th {
            background-color: var(--hover-bg); /* Light background for headers */
            font-weight: 600;
            color: var(--primary-color);
            position: sticky;
            top: 0; /* Stick to the top when scrolling */
            z-index: 10; /* Higher z-index */
            border-bottom: 2px solid var(--secondary-color); /* Stronger border below header */
        }

        /* Sticky first column */
        th:first-child, td:first-child {
            position: sticky;
            left: 0;
            background-color: #fff; /* Ensure white background when sticky */
            z-index: 11; /* Keep page name cell sticky and above other sticky th */
             min-width: 120px; /* Give sticky column enough width */
             box-shadow: 2px 0 3px rgba(0,0,0,0.05); /* Subtle shadow to separate from content */
        }
         th:first-child {
             z-index: 12; /* Page Name Header needs to be on top of sticky category headers too */
         }
         td:first-child {
              font-weight: 500;
              color: var(--light-text-color);
         }


        tr:hover {
            background-color: var(--hover-bg);
        }
         tr:active {
             transform: scale(0.995); /* Softer press effect */
         }


        th.category-header {
             background-color: var(--background-gradient-start); /* Lighter background for category headers */
             text-align: center; /* Center category group titles */
             border-bottom: 1px solid var(--border-color); /* Add a border below category headers */
             color: var(--secondary-color);
        }
        th.category-header + th.category-header {
             border-left: 1px solid var(--border-color); /* Separator between category groups */
        }
         /* Dashed border between category groups in data rows */
         td[data-category="reels"] + td[data-category]:not(:first-child),
         td[data-category="post"] + td[data-category]:not(:first-child) {
              border-left: 1px dashed var(--border-color); /* Subtle visual separator between categories */
         }
         /* Total columns - slightly different styling */
         td:nth-child(odd):not(:first-child, :last-child) { /* Total columns */
             background-color: #f9f9f9; /* Very light grey */
         }


        /* Editable Cell Styling */
        td[contenteditable="true"] {
            cursor: text; /* Indicate editable */
            border: 1px dashed transparent;
            transition: border-color 0.3s ease, background-color 0.3s ease, box-shadow 0.3s ease;
            background-color: #fff; /* Ensure white background for editable cells */
             min-width: 40px; /* Give some space for editing */
             text-align: center; /* Center the number */
             padding: 10px 8px; /* Adjust padding inside editable cell */
             border-radius: 4px;
        }

        td[contenteditable="true"]:hover {
            border-color: var(--border-color);
        }

        td[contenteditable="true"]:focus {
            outline: none;
            border-color: var(--secondary-color);
            background-color: #e3f2fd; /* Light blue focus background */
            box-shadow: 0 0 5px var(--focus-glow); /* Glow effect on focus */
        }

        /* Dynamic Styles based on Data (Table) */
        .done-status {
            font-weight: 600;
        }

        .done-status.completed {
            color: var(--status-completed); /* Green */
        }

        .done-status.partial {
            color: var(--status-partial); /* Orange */
        }

        .done-status.not-started {
             color: var(--status-not-started); /* Red */
        }
         td:last-child { /* More Time cell */
              font-weight: 500;
              text-align: center; /* Center the "X দিন" text */
              color: var(--light-text-color); /* Default time color */
         }
         td:last-child.low-time {
              color: var(--time-low); /* Red */
         }
          td:last-child.medium-time {
              color: var(--time-medium); /* Orange */
         }


        /* Card Section Styles */
        .cards-container {
            display: flex;
            flex-wrap: wrap; /* Allow cards to wrap to the next row */
            gap: 20px; /* Space between cards */
            justify-content: center; /* Center cards when they don't fill a row */
             margin-bottom: 40px;
        }

        .platform-card {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            padding: 18px; /* Adjusted padding */
            width: 220px; /* Adjusted width for cards */
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between; /* Space out content vertically */
            position: relative; /* For potential icons/status indicators */
             animation: fadeInScale 0.8s ease-out; /* Animation for cards */
             min-height: 130px; /* Ensure minimum height */
             border: 1px solid var(--border-color);
        }

        .platform-card:hover {
            transform: translateY(-5px); /* Lift effect on hover */
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .platform-card h3 {
            margin-top: 0;
            margin-bottom: 12px; /* Adjusted margin */
            color: var(--primary-color);
            font-size: 1.1em; /* Slightly smaller font */
            font-weight: 700;
        }

        .card-stats {
            display: flex;
            justify-content: space-around; /* Space out target and done */
            width: 100%;
            margin-bottom: 8px; /* Adjusted margin */
             border-top: 1px solid #eee; /* Subtle separator */
             padding-top: 8px;
        }

        .card-stat-item {
            flex-grow: 1; /* Allow items to grow */
            text-align: center;
        }
         .card-stat-item:first-child {
             border-right: 1px solid #eee; /* Separator between Target and Done */
         }


        .card-stat-label {
            font-size: 0.85em; /* Slightly smaller */
            color: var(--light-text-color);
            display: block;
             margin-bottom: 4px; /* Adjusted margin */
        }

        .card-stat-value {
            font-size: 1.3em; /* Slightly smaller */
            font-weight: 700;
            color: var(--text-color); /* Default value color */
        }

         .editable-done-card {
            cursor: text;
            border: 1px dashed transparent;
            transition: border-color 0.3s ease, background-color 0.3s ease, box-shadow 0.3s ease;
            padding: 2px 5px;
            display: inline-block;
            min-width: 30px;
            text-align: center;
            background-color: #fff;
            border-radius: 4px;
            color: var(--text-color); /* Inherit value color */
         }

         .editable-done-card:hover {
             border-color: var(--border-color);
         }
          .editable-done-card:focus {
            outline: none;
            border-color: var(--secondary-color);
            background-color: #e3f2fd;
             box-shadow: 0 0 5px var(--focus-glow);
         }

         .card-progress {
             font-size: 0.85em;
             color: var(--light-text-color); /* Default progress text color */
              margin-top: auto; /* Push progress to the bottom */
              padding-top: 5px;
               border-top: 1px solid #eee; /* Subtle separator */
               width: 100%; /* Ensure line covers width */
         }


        /* Dynamic Styles for Cards */
        .platform-card.completed .card-stat-value,
        .platform-card.completed .editable-done-card,
        .platform-card.completed .card-progress {
            color: var(--status-completed); /* Green */
            font-weight: 700;
        }


        .platform-card.partial .card-stat-value,
        .platform-card.partial .editable-done-card,
         .platform-card.partial .card-progress {
            color: var(--status-partial); /* Orange */
            font-weight: 700;
        }


        .platform-card.not-started .card-stat-value,
        .platform-card.not-started .editable-done-card,
         .platform-card.not-started .card-progress {
             color: var(--status-not-started); /* Red */
             font-weight: 700;
         }


        /* Animations */
        @keyframes fadeInDown {
            0% { opacity: 0; transform: translateY(-20px); }
            100% { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeInUp {
            0% { opacity: 0; transform: translateY(20px); }
            100% { opacity: 1; transform: translateY(0); }
        }
        @keyframes fadeInScale {
            0% { opacity: 0; transform: scale(0.95); } /* Slightly less scale */
            100% { opacity: 1; transform: scale(1); }
        }


         /* Highlight animation on data update */
         @keyframes highlight {
             0% { background-color: #fff9c4; } /* Lighter yellow */
             50% { background-color: #fff9c4; }
             100% { background-color: transparent; }
         }
         .cell-update-highlight {
             animation: highlight 0.6s ease;
         }

         /* Screenshot mode styles */
         body.screenshot-mode .container {
            box-shadow: none; /* Remove shadow for cleaner capture */
            border-radius: 0;
            padding-top: 25px; /* Remove extra padding */
            min-height: auto; /* Allow container to shrink to content */
         }
         body.screenshot-mode .table-container,
         body.screenshot-mode .platform-card {
             box-shadow: none;
             border-radius: 0;
             border: 1px solid #ccc; /* Add border back for definition */
         }
         body.screenshot-mode th,
         body.screenshot-mode td {
             border-bottom: 1px solid #ddd;
             position: static !important; /* Disable sticky */
             left: auto !important;
             top: auto !important;
             background-color: #fff !important; /* Ensure white background */
             z-index: auto !important;
         }
          body.screenshot-mode th {
               background-color: #eee !important;
          }
          body.screenshot-mode th.category-header {
              background-color: #ddd !important;
          }
         body.screenshot-mode td[contenteditable="true"] {
              border: none !important; /* Remove editable border */
              background-color: #fff !important;
              box-shadow: none !important;
         }
         body.screenshot-mode .platform-card {
              page-break-inside: avoid;
         }


         /* Print Specific Styles (For window.print) */
         @media print {
             body {
                 padding: 10px;
                 background: none;
                 color: #000;
                 font-size: 10pt; /* Smaller font for print */
             }
              body .container {
                   box-shadow: none !important;
                   border-radius: 0 !important;
                   padding: 0 !important;
                   min-height: auto !important;
              }
             h1, h2 {
                 color: #000 !important;
                 margin-bottom: 15px !important;
                 animation: none !important;
             }
             .table-container, .platform-card {
                  box-shadow: none !important;
                  border-radius: 0 !important;
                  border: 1px solid #ccc !important;
                  animation: none !important;
                  margin-bottom: 20px !important;
             }
             table {
                 background-color: #fff !important;
             }
             th, td {
                 padding: 8px 12px !important;
                 border-bottom: 1px solid #ddd !important;
                 white-space: normal !important;
                 overflow: visible !important;
                 text-overflow: initial !important;
                 position: static !important;
                 left: auto !important;
                 top: auto !important;
                 background-color: #fff !important;
                 z-index: auto !important;
             }
              th {
                  background-color: #eee !important;
              }
             td[data-category]:not(:first-child) {
                  border-left: 1px solid #ddd !important;
             }
             th.category-header {
                  border-bottom: 1px solid #ccc !important;
                  background-color: #ddd !important;
             }
              th.category-header + th.category-header {
                  border-left: 1px solid #ccc !important;
             }
             td:nth-child(odd):not(:first-child, :last-child) {
                  background-color: #f9f9f9 !important;
             }
             td[contenteditable="true"] {
                  border: none !important;
                  background-color: #fff !important;
                  box-shadow: none !important;
             }
              .platform-card {
                  width: 200px !important;
                  page-break-inside: avoid !important;
                  display: inline-block !important;
                  vertical-align: top !important;
                  margin-right: 10px !important;
                  padding: 10px !important;
              }
              .platform-card h3 {
                  font-size: 1em !important;
                  margin-bottom: 8px !important;
              }
             .cards-container {
                 justify-content: flex-start !important;
                 gap: 10px !important;
             }
             .card-stats {
                 justify-content: center !important;
                 padding-top: 5px !important;
                 margin-bottom: 5px !important;
             }
             .card-stat-item {
                  padding: 0 5px !important;
                  font-size: 0.9em !important;
             }
              .card-stat-item:first-child {
                  border-right: 1px solid #ddd !important;
             }
             .card-stat-label {
                 font-size: 0.8em !important;
                 margin-bottom: 2px !important;
             }
              .card-stat-value,
              .editable-done-card {
                   font-size: 1em !important;
                   font-weight: bold !important;
              }
             .card-progress {
                 margin-top: 5px !important;
                 font-size: 0.8em !important;
                  padding-top: 5px !important;
             }
              /* Force colors for print */
             .done-status.completed,
             .platform-card.completed .card-stat-value,
             .platform-card.completed .editable-done-card,
             .platform-card.completed .card-progress {
                 color: green !important;
             }
             .done-status.partial,
             .platform-card.partial .card-stat-value,
             .platform-card.partial .editable-done-card,
             .platform-card.partial .card-progress {
                 color: orange !important;
             }
             .done-status.not-started,
             .platform-card.not-started .card-stat-value,
             .platform-card.not-started .editable-done-card,
             .platform-card.not-started .card-progress {
                 color: red !important;
             }
              td:last-child.low-time {
                  color: red !important;
              }
              td:last-child.medium-time {
                  color: orange !important;
              }
         }


    </style>
</head>
<body>

    <div class="container">
         <!-- Home Button (Excluded from Screenshot & Print) -->
         <div class="home-button exclude-screenshot" title="উপরে যান" role="button" aria-label="উপরে যান">
             <i class="fas fa-home"></i>
         </div>

        <h1>সোশ্যাল মিডিয়া পোস্ট ম্যানেজমেন্ট টুল</h1>

        <!-- Action Buttons (Excluded from Screenshot & Print) -->
        <div class="action-buttons exclude-screenshot">
            <button id="printPageButton" title="পেজের বর্তমান লেআউট প্রিন্ট করুন অথবা PDF হিসেবে সেভ করুন">
                 <i class="fas fa-print"></i> পেজ প্রিন্ট / সেভ PDF
            </button>
             <button id="screenshotButton" title="পেজের দৃশ্যমান অংশের একটি ইমেজ ডাউনলোড করুন">
                 <i class="fas fa-camera"></i> স্ক্রিনশট
             </button>
             <button id="printDataButton" title="ডেটা একটি নতুন উইন্ডোতে প্রিন্ট করার জন্য খুলুন">
                  <i class="fas fa-table"></i> ডেটা প্রিন্ট
             </button>
            <!-- <button id="resetButton">ডাটা রিসেট করুন</button> --> <!-- Optional Reset Button -->
        </div>


        <h2>ফেসবুক পেজ ম্যানেজমেন্ট</h2>
         <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th rowspan="2">পেজের নাম</th>
                        <th colspan="2" class="category-header">রিলস</th>
                        <th colspan="2" class="category-header">পোস্ট</th>
                        <th colspan="2" class="category-header">স্টোরি</th>
                        <th rowspan="2">আর সময় আছে</th>
                    </tr>
                     <tr>
                        <th>মোট</th>
                        <th>সম্পন্ন</th>
                        <th>মোট</th>
                        <th>সম্পন্ন</th>
                        <th>মোট</th>
                        <th>সম্পন্ন</th>
                    </tr>
                </thead>
                <tbody id="facebookTableBody">
                    <!-- Facebook Data will be rendered here by JavaScript -->
                </tbody>
            </table>
         </div>


        <h2>অন্যান্য প্ল্যাটফর্ম</h2>
        <div class="cards-container" id="otherPlatformsContainer">
            <!-- Other Platforms Data will be rendered here by JavaScript -->
        </div>
    </div>

    <script>
        // Unique keys for localStorage
        const localStorageKey = 'socialMediaPostData';
        const lastResetWeekKey = 'socialMediaLastResetWeekId'; // For tracking weekly reset

        const facebookTableBody = document.getElementById('facebookTableBody');
        const otherPlatformsContainer = document.getElementById('otherPlatformsContainer');
         const printPageButton = document.getElementById('printPageButton');
         const screenshotButton = document.getElementById('screenshotButton');
         const printDataButton = document.getElementById('printDataButton');
         const homeButton = document.querySelector('.home-button');
         const container = document.querySelector('.container');
         // const resetButton = document.getElementById('resetButton');

         console.log("Script started.");

        // Define Facebook categories
        const facebookCategories = ['reels', 'post', 'story'];
        const facebookCategoryLabels = {
            reels: 'রিলস',
            post: 'পোস্ট',
            story: 'স্টোরি'
        };

         // Define Other Platforms and their initial structure as an ARRAY of accounts
         const initialOtherPlatformsStructure = [
             { id: 'tiktok1', platform: 'TikTok', name: 'TikTok U Tech', target: 2, done: 0 },
             { id: 'tiktok2', platform: 'TikTok', name: 'TikTok Your TopUp Center ', target: 2, done: 0 },
             { id: 'insta1', platform: 'Instagram', name: 'Instagram U Tech', target: 1, done: 0 },
             { id: 'insta2', platform: 'Instagram', name: 'Instagram Your TopUp Center ', target: 1, done: 0 },
             { id: 'youtube', platform: 'YouTube', name: 'YouTube', target: 2, done: 0 },
             { id: 'blogspot', platform: 'Blog', name: 'ব্লগ পোস্ট', target: 1, done: 0 },
             { id: 'twitter', platform: 'Twitter', name: 'Twitter (Posts)', target: 1, done: 0 }
         ];


        // Default initial data structure for 5 Facebook pages & other platforms
        const defaultDataStructure = {
             facebookPages: [
                {
                    name: "U Tech",
                    categories: {
                        reels: { total: 1, done: 0 },
                        post: { total: 2, done: 0 },
                        story: { total: 1, done: 0 }
                    }
                },
                {
                    name: "YTC",
                    categories: {
                        reels: { total: 1, done: 0 },
                        post: { total: 2, done: 0 },
                        story: { total: 1, done: 0 }
                    }
                },
                {
                    name: "Quantum",
                    categories: {
                         reels: { total: 1, done: 0 },
                        post: { total: 1, done: 0 },
                        story: { total: 1, done: 0 }
                    }
                },
                {
                    name: "GreenShell",
                    categories: {
                         reels: { total: 1, done: 0 },
                        post: { total: 1, done: 0 },
                        story: { total: 0, done: 0 }
                    }
                },
                {
                    name: "WeUx",
                    categories: {
                        reels: { total: 1, done: 0 },
                        post: { total: 1, done: 0 },
                        story: { total: 0, done: 0 }
                    }
                }
            ],
            otherPlatforms: JSON.parse(JSON.stringify(initialOtherPlatformsStructure))
        };


        let socialMediaData = {}; // Object to hold all current data


        // Function to get a unique ID for the current week (Saturday to Friday)
        function getCurrentWeekId() {
            const d = new Date();
            const dayOfWeek = d.getDay(); // 0=Sun, ..., 6=Sat
            // Calculate days to subtract to get to the previous/current Saturday
            // If today is Sat (6), (6+1)%7 = 0 days to subtract.
            // If today is Sun (0), (0+1)%7 = 1 day to subtract.
            // If today is Fri (5), (5+1)%7 = 6 days to subtract.
            const daysToSubtract = (dayOfWeek + 1) % 7;
            const startOfWeek = new Date(d);
            startOfWeek.setDate(d.getDate() - daysToSubtract);
            startOfWeek.setHours(0, 0, 0, 0); // Normalize to the beginning of that Saturday
            return startOfWeek.toISOString().substring(0, 10); // YYYY-MM-DD format
        }

        // Function to reset 'done' counts in the data structure
        function resetWeeklyDoneCounts(dataToReset) {
            console.log("New week detected. Resetting 'done' counts for all items.");
            // Reset Facebook pages' 'done' counts
            if (dataToReset && dataToReset.facebookPages && Array.isArray(dataToReset.facebookPages)) {
                dataToReset.facebookPages.forEach(page => {
                    if (page && page.categories && typeof page.categories === 'object') {
                        Object.keys(page.categories).forEach(categoryKey => {
                            const category = page.categories[categoryKey];
                            if (category && typeof category.done === 'number') {
                                category.done = 0;
                            }
                        });
                    }
                });
            }
            // Reset Other platforms' 'done' counts
            if (dataToReset && dataToReset.otherPlatforms && Array.isArray(dataToReset.otherPlatforms)) {
                dataToReset.otherPlatforms.forEach(platform => {
                    if (platform && typeof platform.done === 'number') {
                        platform.done = 0;
                    }
                });
            }
            return dataToReset; // Return the modified data (modified in place)
        }


        // Function to load data from local storage
        function loadData() {
            console.log("Attempting to load data from localStorage...");
            const storedSocialDataString = localStorage.getItem(localStorageKey);
            const storedLastResetWeekId = localStorage.getItem(lastResetWeekKey);
            const currentWeekId = getCurrentWeekId();
            console.log(`Current Week ID: ${currentWeekId}, Stored Last Reset Week ID: ${storedLastResetWeekId}`);

            let dataToProcess; // This will hold the data structure that validation logic will work on.

            if (storedSocialDataString) {
                try {
                    dataToProcess = JSON.parse(storedSocialDataString);
                    console.log("Data parsed successfully from localStorage:", JSON.parse(JSON.stringify(dataToProcess))); // Log a copy

                    if (currentWeekId !== storedLastResetWeekId) {
                        console.log(`Current week ID (${currentWeekId}) differs from stored (${storedLastResetWeekId}). Triggering weekly reset of 'done' counts.`);
                        dataToProcess = resetWeeklyDoneCounts(dataToProcess); // Modify dataToProcess in place
                        localStorage.setItem(lastResetWeekKey, currentWeekId); // Update the stored week ID
                        console.log("Data after weekly reset:", JSON.parse(JSON.stringify(dataToProcess))); // Log a copy
                    } else {
                        console.log(`Current week ID (${currentWeekId}) matches stored. No weekly reset needed.`);
                    }
                } catch (e) {
                    console.error("Error parsing local storage data:", e);
                    alert("ডাটা লোড করতে সমস্যা হয়েছে। ডিফল্ট ডেটা দিয়ে শুরু করা হচ্ছে।");
                    dataToProcess = JSON.parse(JSON.stringify(defaultDataStructure)); // Fallback to default
                    localStorage.setItem(lastResetWeekKey, currentWeekId); // Set week ID for fresh start with default
                    console.log("Using default data due to parsing error.");
                }
            } else {
                // No data in local storage, use the default data (which has done: 0)
                dataToProcess = JSON.parse(JSON.stringify(defaultDataStructure));
                localStorage.setItem(lastResetWeekKey, currentWeekId); // Set week ID for fresh start
                console.log("No data found in local storage, using default data and setting current week ID.");
            }

            // --- Validate and merge Data (Facebook Pages) ---
            const validFacebookPages = defaultDataStructure.facebookPages.map(defaultPage => {
                const processedPageData = (dataToProcess.facebookPages && Array.isArray(dataToProcess.facebookPages))
                    ? dataToProcess.facebookPages.find(p => p.name === defaultPage.name)
                    : null;
                const page = JSON.parse(JSON.stringify(defaultPage)); // Start with deep copy of default

                if (processedPageData) {
                    if (typeof processedPageData.categories === 'object' && processedPageData.categories !== null) {
                        facebookCategories.forEach(categoryKey => {
                            const defaultCategoryData = defaultPage.categories[categoryKey] || { total: 0, done: 0 };
                            const processedCategoryData = processedPageData.categories[categoryKey];

                            if (processedCategoryData && typeof processedCategoryData === 'object') {
                                let total = parseInt(processedCategoryData.total, 10);
                                if (isNaN(total) || total < 0) total = defaultCategoryData.total;
                                page.categories[categoryKey].total = total;

                                let done = parseInt(processedCategoryData.done, 10);
                                if (isNaN(done) || done < 0) done = 0; // Fallback if corrupt, or use 0 from reset
                                page.categories[categoryKey].done = Math.min(done, total);
                            } else {
                                page.categories[categoryKey] = JSON.parse(JSON.stringify(defaultCategoryData));
                            }
                        });
                    }
                }
                return page;
            });
            socialMediaData.facebookPages = validFacebookPages;
            console.log("Facebook pages data populated into socialMediaData:", JSON.parse(JSON.stringify(socialMediaData.facebookPages)));


            // --- Validate and merge Data (Other Platforms - Array) ---
            const validOtherPlatforms = [];
            const processedPlatformsMap = (dataToProcess.otherPlatforms && Array.isArray(dataToProcess.otherPlatforms))
                ? dataToProcess.otherPlatforms.reduce((map, p) => { if(p && p.id) map[p.id] = p; return map; }, {})
                : {};

            initialOtherPlatformsStructure.forEach(defaultPlatform => {
                const platform = JSON.parse(JSON.stringify(defaultPlatform));
                const processedPlatformData = processedPlatformsMap[defaultPlatform.id];

                if (processedPlatformData) {
                    if (typeof processedPlatformData.name === 'string') platform.name = processedPlatformData.name;
                    if (typeof processedPlatformData.platform === 'string') platform.platform = processedPlatformData.platform;

                    let target = parseInt(processedPlatformData.target, 10);
                    if (isNaN(target) || target < 0) target = defaultPlatform.target;
                    platform.target = target;

                    let done = parseInt(processedPlatformData.done, 10);
                    if (isNaN(done) || done < 0) done = 0; // Fallback or use 0 from reset
                    platform.done = done;
                }
                validOtherPlatforms.push(platform);
            });

            if (dataToProcess.otherPlatforms && Array.isArray(dataToProcess.otherPlatforms)) {
                dataToProcess.otherPlatforms.forEach(processedPlatform => {
                    if (processedPlatform && processedPlatform.id && !initialOtherPlatformsStructure.some(dp => dp.id === processedPlatform.id)) {
                        const newPlatform = {
                            id: processedPlatform.id,
                            name: typeof processedPlatform.name === 'string' ? processedPlatform.name : 'Unnamed Platform',
                            platform: typeof processedPlatform.platform === 'string' ? processedPlatform.platform : 'Other',
                            target: 0, done: 0
                        };
                        let target = parseInt(processedPlatform.target, 10);
                        if (!isNaN(target) && target >= 0) newPlatform.target = target;

                        let done = parseInt(processedPlatform.done, 10);
                        if (!isNaN(done) && done >= 0) newPlatform.done = done;

                        validOtherPlatforms.push(newPlatform);
                        console.log(`Added extra platform from storage: ${newPlatform.name} (ID: ${newPlatform.id})`);
                    }
                });
            }
            socialMediaData.otherPlatforms = validOtherPlatforms;
            console.log("Other platforms data populated into socialMediaData:", JSON.parse(JSON.stringify(socialMediaData.otherPlatforms)));

            console.log("Final socialMediaData after all processing in loadData:", JSON.parse(JSON.stringify(socialMediaData)));
        }


        // Function to save the current data to local storage
        function saveData() {
            console.log("Attempting to save data to localStorage...");
            try {
                 localStorage.setItem(localStorageKey, JSON.stringify(socialMediaData));
                 console.log("Data saved successfully to local storage.");
            } catch (e) {
                console.error("Error saving data to local storage:", e);
                if (e.name === 'QuotaExceededError') {
                    alert("আপনার ব্রাউজারের লোকাল স্টোরেজ পূর্ণ। ডাটা সেভ করা যাচ্ছে না। কিছু ডাটা সরিয়ে জায়গা খালি করুন অথবা ব্রাউজার ক্যাশে এবং কুকিজ পরিষ্কার করুন।");
                } else {
                    alert("ডাটা সেভ করার সমস্যা হচ্ছে।");
                }
            }
        }

        // Function to calculate days left in the week (week starts Saturday)
        function getDaysLeftInWeek() {
            const today = new Date();
            const dayOfWeek = today.getDay(); // getDay() returns 0 for Sunday, ..., 6 for Saturday
            const saturdayBasedDayIndex = (dayOfWeek + 1) % 7; // Sat=0, Sun=1 ... Fri=6
            return 6 - saturdayBasedDayIndex; // Days left until Friday (inclusive of today)
        }


        // Function to render the Facebook table body
        function renderFacebookTable(highlightPageIndex = -1, highlightCategory = null) {
            console.log("Rendering Facebook table...");
            facebookTableBody.innerHTML = '';
            const daysLeft = getDaysLeftInWeek();

            socialMediaData.facebookPages.forEach((page, pageIndex) => {
                if (!page || typeof page.name !== 'string' || typeof page.categories !== 'object') {
                     console.error("Skipping render for invalid Facebook page data:", page);
                     return;
                }
                const row = facebookTableBody.insertRow();
                row.dataset.pageIndex = pageIndex;
                const nameCell = row.insertCell();
                nameCell.textContent = page.name;

                facebookCategories.forEach(categoryKey => {
                    const categoryData = page.categories[categoryKey] || { total: 0, done: 0 }; // Ensure categoryData exists
                    const total = categoryData.total;
                    const done = categoryData.done;

                    const totalCell = row.insertCell();
                    totalCell.textContent = total;
                    totalCell.style.fontWeight = '500';

                    const doneCell = row.insertCell();
                    doneCell.textContent = done;
                    doneCell.setAttribute('contenteditable', 'true');
                    doneCell.dataset.category = categoryKey;
                    doneCell.dataset.pageIndex = pageIndex;
                    doneCell.classList.add('editable-done-category');

                    doneCell.classList.remove('done-status', 'completed', 'partial', 'not-started'); // Clear previous
                    if (total > 0) {
                         if (done >= total) doneCell.classList.add('done-status', 'completed');
                         else if (done > 0) doneCell.classList.add('done-status', 'partial');
                         else doneCell.classList.add('done-status', 'not-started');
                     }

                    if (pageIndex === highlightPageIndex && categoryKey === highlightCategory) {
                        requestAnimationFrame(() => {
                             doneCell.classList.add('cell-update-highlight');
                            doneCell.addEventListener('animationend', () => doneCell.classList.remove('cell-update-highlight'), { once: true });
                        });
                    }
                });

                const moreTimeCell = row.insertCell();
                moreTimeCell.textContent = daysLeft + " দিন";
                moreTimeCell.classList.remove('low-time', 'medium-time'); // Clear previous
                 if (daysLeft <= 1) moreTimeCell.classList.add('low-time');
                 else if (daysLeft <= 3) moreTimeCell.classList.add('medium-time');
            });
             console.log("Facebook table rendering complete.");
        }

        // Function to render the Other Platforms cards
        function renderOtherPlatformsCards(highlightAccountIndex = -1) {
            console.log("Rendering other platforms cards...");
            otherPlatformsContainer.innerHTML = '';

            socialMediaData.otherPlatforms.forEach((account, accountIndex) => {
                 if (!account || typeof account.name !== 'string' || typeof account.platform !== 'string' || typeof account.target !== 'number' || typeof account.done !== 'number') {
                      console.error("Skipping render for invalid other platform account data:", account);
                      return;
                 }
                const card = document.createElement('div');
                card.classList.add('platform-card');
                card.dataset.accountIndex = accountIndex;

                let statusClass = '';
                if (account.target > 0) {
                    if (account.done >= account.target) statusClass = 'completed';
                    else if (account.done > 0) statusClass = 'partial';
                    else statusClass = 'not-started';
                } else if (account.done > 0) {
                     statusClass = 'completed';
                 }
                card.classList.remove('completed', 'partial', 'not-started'); // Clear previous
                if (statusClass) card.classList.add(statusClass);

                let progressText = '';
                if (account.target > 0) progressText = `(${Math.min(account.done, account.target)}/${account.target}) সম্পন্ন`;
                else if (account.done > 0) progressText = `(${account.done} সম্পন্ন)`;

                card.innerHTML = `
                    <h3>${account.name}</h3>
                    <div class="card-stats">
                        <div class="card-stat-item">
                            <span class="card-stat-label">টার্গেট</span>
                            <span class="card-stat-value">${account.target}</span>
                        </div>
                        <div class="card-stat-item">
                            <span class="card-stat-label">সম্পন্ন</span>
                             <span class="card-stat-value editable-done-card" contenteditable="true" data-account-index="${accountIndex}">${account.done}</span>
                        </div>
                    </div>
                     ${progressText ? `<div class="card-progress">${progressText}</div>` : ''}
                `;
                 const editableSpan = card.querySelector('.editable-done-card');
                 if (accountIndex === highlightAccountIndex && editableSpan) {
                     requestAnimationFrame(() => {
                          editableSpan.classList.add('cell-update-highlight');
                         editableSpan.addEventListener('animationend', () => editableSpan.classList.remove('cell-update-highlight'), { once: true });
                     });
                 }
                otherPlatformsContainer.appendChild(card);
            });
             console.log("Other platforms card rendering complete.");
        }

         // Function to capture the content as an image using html2canvas
         function takeScreenshot() {
             console.log("Screenshot button clicked.");
             document.body.classList.add('screenshot-mode');
             requestAnimationFrame(() => {
                html2canvas(container, { useCORS: true, scrollY: -window.scrollY, windowWidth: document.documentElement.offsetWidth, windowHeight: document.documentElement.offsetHeight })
                .then(canvas => {
                    const imageDataUrl = canvas.toDataURL('image/png');
                    const link = document.createElement('a');
                    link.href = imageDataUrl;
                    link.download = `social_media_report_${new Date().toISOString().split('T')[0]}.png`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    document.body.classList.remove('screenshot-mode');
                    console.log("Screenshot captured and download initiated.");
                }).catch(error => {
                    console.error("Error capturing screenshot:", error);
                    alert("স্ক্রিনশট নিতে সমস্যা হয়েছে।");
                    document.body.classList.remove('screenshot-mode');
                });
             });
         }

         // Function to generate and display data in a new window for printing
         function printDataSummary() {
             console.log("Print Data button clicked. Generating data summary.");
             let dataHtml = `
                <!DOCTYPE html><html lang="bn"><head><meta charset="UTF-8"><title>সোশ্যাল মিডিয়া ডেটা</title>
                <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;500;700&display=swap" rel="stylesheet">
                <style>
                    body { font-family: 'Noto Sans Bengali', sans-serif; margin: 20px; color: #333; }
                    h1, h2 { color: #1c2b5d; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 5px;}
                    h2 { margin-top: 25px; color: #4267b2; }
                    table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                    th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
                    th { background-color: #f2f2f2; font-weight: bold; } tbody tr:nth-child(even) { background-color: #f9f9f9; }
                    @media print { body { margin: 10mm; font-size: 10pt; } h1, h2, table, li { page-break-after: avoid; page-break-inside: avoid; } }
                </style></head><body><h1>সোশ্যাল মিডিয়া পোস্ট ম্যানেজমেন্ট - ডেটা সারাংশ</h1>`;

            dataHtml += `<h2>ফেসবুক পেজ ডেটা</h2><table><thead><tr><th>পেজের নাম</th>
                         <th>রিলস (মোট)</th><th>রিলস (সম্পন্ন)</th><th>পোস্ট (মোট)</th><th>পোস্ট (সম্পন্ন)</th>
                         <th>স্টোরি (মোট)</th><th>স্টোরি (সম্পন্ন)</th></tr></thead><tbody>`;
            socialMediaData.facebookPages.forEach(page => {
                if (!page || !page.categories) return;
                dataHtml += `<tr><td>${page.name}</td>
                             <td>${page.categories.reels?.total || 0}</td><td>${page.categories.reels?.done || 0}</td>
                             <td>${page.categories.post?.total || 0}</td><td>${page.categories.post?.done || 0}</td>
                             <td>${page.categories.story?.total || 0}</td><td>${page.categories.story?.done || 0}</td></tr>`;
            });
            dataHtml += `</tbody></table>`;

            dataHtml += `<h2>অন্যান্য প্ল্যাটফর্ম ডেটা</h2><table><thead><tr><th>প্ল্যাটফর্ম</th><th>অ্যাকাউন্টের নাম</th>
                         <th>টার্গেট</th><th>সম্পন্ন</th></tr></thead><tbody>`;
            socialMediaData.otherPlatforms.forEach(account => {
                 if (!account) return;
                dataHtml += `<tr><td>${account.platform}</td><td>${account.name}</td>
                             <td>${account.target}</td><td>${account.done}</td></tr>`;
            });
            dataHtml += `</tbody></table></body></html>`;

            const printWindow = window.open('', '_blank');
             if (!printWindow) {
                 alert("পপআপ ব্লক করা হয়েছে। অনুগ্রহ করে পপআপ আনব্লক করে আবার চেষ্টা করুন।"); return;
             }
            printWindow.document.open();
            printWindow.document.write(dataHtml);
            printWindow.document.close();
            printWindow.onload = () => { printWindow.print(); };
            console.log("Data print window opened.");
         }


        // --- Event Listeners ---
         homeButton.addEventListener('click', () => window.scrollTo({ top: 0, behavior: 'smooth' }));
         printPageButton.addEventListener('click', () => window.print());
         screenshotButton.addEventListener('click', takeScreenshot);
         printDataButton.addEventListener('click', printDataSummary);

        facebookTableBody.addEventListener('blur', function(event) {
            const target = event.target;
            if (target.tagName === 'TD' && target.classList.contains('editable-done-category')) {
                const pageIndex = parseInt(target.dataset.pageIndex, 10);
                const categoryKey = target.dataset.category;
                if (isNaN(pageIndex) || !socialMediaData.facebookPages[pageIndex]?.categories?.[categoryKey]) return;

                const page = socialMediaData.facebookPages[pageIndex];
                const categoryData = page.categories[categoryKey];
                const rawValue = target.textContent.trim();
                const newValue = parseInt(rawValue, 10);
                const oldValue = categoryData.done;

                if (!isNaN(newValue) && newValue >= 0) {
                     const validatedValue = Math.min(newValue, categoryData.total);
                     if (validatedValue !== oldValue) {
                        categoryData.done = validatedValue;
                        saveData();
                        if (validatedValue !== newValue) alert(`সম্পন্ন সংখ্যা মোট সংখ্যার (${categoryData.total}) বেশি হতে পারে না। তাই ${validatedValue} করা হয়েছে।`);
                        renderFacebookTable(pageIndex, categoryKey);
                     } else { target.textContent = oldValue; }
                } else {
                    alert("অনুগ্রহ করে সঠিক সংখ্যা লিখুন (০ বা তার বেশি)।");
                    target.textContent = oldValue;
                }
            }
        }, true);

        otherPlatformsContainer.addEventListener('blur', function(event) {
             const target = event.target;
             if (target.tagName === 'SPAN' && target.classList.contains('editable-done-card')) {
                const accountIndex = parseInt(target.dataset.accountIndex, 10);
                if (isNaN(accountIndex) || !socialMediaData.otherPlatforms[accountIndex]) return;

                const account = socialMediaData.otherPlatforms[accountIndex];
                const rawValue = target.textContent.trim();
                const newValue = parseInt(rawValue, 10);
                const oldValue = account.done;

                 if (!isNaN(newValue) && newValue >= 0) {
                      if (newValue !== oldValue) {
                          account.done = newValue;
                          saveData();
                          renderOtherPlatformsCards(accountIndex);
                      } else { target.textContent = oldValue; }
                 } else {
                     alert("অনুগ্রহ করে সঠিক সংখ্যা লিখুন (০ বা তার বেশি)।");
                     target.textContent = oldValue;
                 }
             }
        }, true);

        document.addEventListener('keydown', function(event) {
            const target = event.target;
            if (target.isContentEditable && event.key === 'Enter') {
                 if (target.classList.contains('editable-done-category') || target.classList.contains('editable-done-card')) {
                    event.preventDefault();
                    target.blur();
                 }
            }
        });


        // --- Initial setup ---
        loadData();
        renderFacebookTable();
        renderOtherPlatformsCards();
        console.log("Initial render complete.");

    </script>

</body>
</html>
